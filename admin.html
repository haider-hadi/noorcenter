<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin | NOOR CENTER</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    :root { --gold: #d4af37; --dark: #1a1a1a; --white: #ffffff; --grey: #f4f4f4; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--grey); margin: 0; }
    .header { background: var(--dark); color: var(--gold); padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }
    .container { max-width: 1000px; margin: 30px auto; padding: 20px; }
    .box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    
    input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    button { background: var(--dark); color: white; border: none; padding: 12px 25px; cursor: pointer; border-radius: 5px; font-weight: bold; width: 100%; transition: 0.3s; }
    button:hover { background: var(--gold); color: var(--dark); }
    
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { flex: 1; background: #ddd; color: #333; padding: 10px; border-radius: 5px; text-align: center; cursor: pointer; border: none; }
    .tab-btn.active { background: var(--gold); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    th, td { padding: 12px; border: 1px solid #eee; text-align: left; font-size: 14px; }
    th { background: var(--dark); color: white; }
    .prod-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-completed { background: #d4edda; color: #155724; }
    
    .delete-btn { background: #ff4d4d; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; width: auto; }
    .complete-btn { background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; width: auto; margin-top: 5px; }
    .edit-btn { background: #007bff; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; width: auto; margin-top: 5px; }

    .row { display: flex; gap: 20px; }
    .row .half { flex: 1; }
</style>
</head>

<body>

<header class="header">NOOR CENTER Admin Panel</header>

<section class="container">

  <div id="loginBox" class="box">
    <h3>Admin Security</h3>
    <input id="adminUser" placeholder="Username (noorcenter)">
    <input id="adminPass" type="password" placeholder="Password (noor123)">
    <button onclick="adminLogin()">Access Dashboard</button>
  </div>

  <div id="adminPanel" style="display:none">
    
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab(event,'addProductTab')">Add Product</button>
      <button class="tab-btn" onclick="openTab(event,'productsTab')">Inventory</button>
      <button class="tab-btn" onclick="openTab(event,'ordersTab')">Orders</button>
      <button class="tab-btn" onclick="openTab(event,'messagesTab')">Messages</button>
    </div>

    <!-- ADD PRODUCT -->
    <div id="addProductTab" class="tab-content active box">
      <h3>Post New Product</h3>
      <input id="pId" placeholder="Internal ID (e.g., ITEM-101)">
      <input id="pName" placeholder="Product Name">
      <input id="pPrice" type="number" placeholder="Price (RS)">
      <select id="pCat">
        <option value="Men">Men</option>
        <option value="Women">Women</option>
        <option value="Kids">Kids</option>
        <option value="Jewelry">Jewelry</option>
      </select>
      <textarea id="pDesc" placeholder="Product Description..."></textarea>
      <label>Product Image:</label>
      <input id="pImg" type="file" accept="image/*">
      <button id="addBtn" onclick="addProduct()">Save Product to Database</button>
    </div>

    <!-- INVENTORY -->
    <div id="productsTab" class="tab-content box">
      <h3>Manage Inventory</h3>
      <div style="overflow-x: auto;">
          <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Category</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="adminProductsBody"></tbody>
          </table>
      </div>
    </div>

    <!-- ORDERS -->
    <div id="ordersTab" class="tab-content box">
      <h3>Received Orders</h3>
      <div id="adminOrders">Loading orders...</div>
    </div>

    <!-- MESSAGES -->
    <div id="messagesTab" class="tab-content box">
      <h3>Customer Messages</h3>
      <div id="adminMessages">No messages received.</div>
    </div>

  </div>
</section>

<script>
const SUPABASE_URL = 'https://lqcdfysynegysckwzkwc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_m_sUuDgmsI3_MRWRxVBxWg__aVu_0hj';
const PRODUCT_BUCKET = 'product-images';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function openTab(evt, tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    evt.currentTarget.classList.add('active');
    
    if(tabId === 'productsTab') fetchProducts();
    if(tabId === 'ordersTab') fetchOrders();
    if(tabId === 'messagesTab') fetchMessages();
}

function adminLogin() {
    const user = document.getElementById('adminUser').value;
    const pass = document.getElementById('adminPass').value;
    if(user === 'noorcenter' && pass === 'noor123') {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
    } else {
        alert('Invalid credentials!');
    }
}

/* ---------------- PRODUCTS ---------------- */
async function addProduct() {
    const btn = document.getElementById('addBtn');
    const file = document.getElementById('pImg').files[0];
    const id_admin = document.getElementById('pId').value;
    const name = document.getElementById('pName').value;
    const price = document.getElementById('pPrice').value;
    const category = document.getElementById('pCat').value;
    const description = document.getElementById('pDesc').value;

    if(!file || !name || !price || !id_admin) return alert('Please fill all fields!');

    btn.innerText = "Uploading...";
    btn.disabled = true;

    try {
        const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
        const { error: uploadError } = await _supabase.storage.from(PRODUCT_BUCKET).upload(fileName, file);
        if (uploadError) throw uploadError;

        const { error: insertError } = await _supabase.from('products').insert([{
            id_admin, name, price: parseFloat(price), category, description, image_path: fileName
        }]);
        if (insertError) throw insertError;

        alert('Product added!');
        fetchProducts();
        document.getElementById('pId').value='';
        document.getElementById('pName').value='';
        document.getElementById('pPrice').value='';
        document.getElementById('pDesc').value='';
        document.getElementById('pImg').value='';
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        btn.innerText = "Save Product to Database";
        btn.disabled = false;
    }
}

async function fetchProducts() {
    const { data, error } = await _supabase.from('products').select('*').order('created_at', {ascending: false});
    const tbody = document.getElementById('adminProductsBody');
    tbody.innerHTML = '';
    if(data) {
        data.forEach(p => {
            const imgUrl = `${SUPABASE_URL}/storage/v1/object/public/${PRODUCT_BUCKET}/${p.image_path}`;
            tbody.innerHTML += `
                <tr>
                    <td><img src="${imgUrl}" class="prod-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td>${p.id_admin}</td>
                    <td>${p.name}</td>
                    <td>RS. ${p.price}</td>
                    <td>${p.category}</td>
                    <td>
                        <button class="edit-btn" onclick="editProduct('${p.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteProduct('${p.id}', '${p.image_path}')">Delete</button>
                    </td>
                </tr>`;
        });
    }
}

async function deleteProduct(dbId, imgPath) {
    if(confirm('Delete this product?')) {
        await _supabase.from('products').delete().eq('id', dbId);
        await _supabase.storage.from(PRODUCT_BUCKET).remove([imgPath]);
        fetchProducts();
    }
}

/* ---------------- EDIT PRODUCT ---------------- */
async function editProduct(dbId) {
    const { data } = await _supabase.from('products').select('*').eq('id', dbId).single();
    if(!data) return alert("Product not found!");

    const newName = prompt("Enter new product name:", data.name);
    if(newName === null) return;

    const newPrice = prompt("Enter new price:", data.price);
    if(newPrice === null) return;

    const newCat = prompt("Enter new category (Men/Women/Kids/Jewelry):", data.category);
    if(newCat === null) return;

    const newDesc = prompt("Enter new description:", data.description);
    if(newDesc === null) return;

    const { error } = await _supabase.from('products').update({
        name: newName,
        price: parseFloat(newPrice),
        category: newCat,
        description: newDesc
    }).eq('id', dbId);

    if(error) alert("Update failed: " + error.message);
    else {
        alert("Product updated!");
        fetchProducts();
    }
}

/* ---------------- ORDERS ---------------- */
async function fetchOrders() {
    const container = document.getElementById('adminOrders');
    container.innerHTML = "Fetching orders...";

    const { data, error } = await _supabase
        .from('orders')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = "Error loading orders: " + error.message;
        return;
    }

    if (data && data.length > 0) {
        container.innerHTML = data.map(o => `
            <div class="box" style="border: 1px solid #eee; margin-bottom: 10px; box-shadow: none;">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <p><strong>Order ID:</strong> ${o.id.slice(0,8)}</p>
                        <p><strong>Customer:</strong> ${o.customer_name} (${o.phone})</p>
                        <p><strong>Address:</strong> ${o.address}</p>
                        <p><strong>Items:</strong> ${JSON.stringify(o.items)}</p>
                    </div>
                    <div style="text-align: right;">
                        <p><strong>Total:</strong> RS. ${o.total_price}</p>
                        <span class="status-badge status-${o.status}">${o.status}</span>
                    </div>
                </div>
                ${o.status === 'pending' ? 
                    `<button class="complete-btn" onclick="updateOrderStatus('${o.id}', 'completed')">Mark Completed</button>` 
                    : `<button class="delete-btn" onclick="deleteOrder('${o.id}')">Delete Completed</button>`}
            </div>
        `).join('');
    } else {
        container.innerHTML = "No orders found.";
    }
}

async function updateOrderStatus(orderId, newStatus) {
    const { error } = await _supabase
        .from('orders')
        .update({ status: newStatus })
        .eq('id', orderId);
    
    if (!error) {
        fetchOrders();
    } else {
        alert("Failed to update: " + error.message);
    }
}

async function deleteOrder(orderId) {
    if(!confirm("Delete this completed order?")) return;
    const { error } = await _supabase.from('orders').delete().eq('id', orderId);
    if(error) alert("Delete failed: " + error.message);
    else fetchOrders();
}

/* ---------------- MESSAGES ---------------- */
async function fetchMessages() {
    const container = document.getElementById('adminMessages');
    container.innerHTML = "Loading messages...";

    const { data, error } = await _supabase
        .from('messages')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) {
        container.innerHTML = "Error: " + error.message;
        return;
    }

    if(data && data.length > 0) {
        container.innerHTML = data.map(m => `
            <div class="box" style="border:1px solid #eee; box-shadow:none; position:relative;">
                <p><strong>From:</strong> ${m.name} (${m.email})</p>
                <p><strong>Phone:</strong> ${m.phone}</p>
                <p><strong>Message:</strong> ${m.message}</p>
                <small style="color:#999">${new Date(m.created_at).toLocaleString()}</small>
                <br>
                <button onclick="deleteMessage('${m.id}')" class="delete-btn" style="width:auto; margin-top:10px;">Delete Message</button>
            </div>
        `).join('');
    } else {
        container.innerHTML = "No messages found.";
    }
}

async function deleteMessage(msgId) {
    if(!confirm("Are you sure you want to delete this message?")) return;
    
    const { error } = await _supabase
        .from('messages')
        .delete()
        .eq('id', msgId);

    if (error) alert("Error: " + error.message);
    else {
        alert("Message deleted!");
        fetchMessages();
    }
}
</script>

</body>
</html>
